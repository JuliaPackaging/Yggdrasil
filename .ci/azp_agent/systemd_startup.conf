[Unit]
Description           = Yggdrasil AZP Agent ${AGENT_IDX}
StartLimitIntervalSec = 0
StartLimitBurst       = 0

[Service]
PermissionsStartOnly  = true
ExecStartPre          = /bin/bash -c "rm -rf /tmp/azp_agent_${AGENT_IDX}; mkdir -p /tmp/azp_agent_${AGENT_IDX}"
                        # We can't use `WorkingDirectory` here, because it tries to chdir before running the
                        # above `ExecStartPre`, which obviously won't work
Environment           = AZP_PREFIX="/tmp/azp_agent_${AGENT_IDX}"
Environment           = AZP_AGENT_NAME="${HOSTNAME}.${AGENT_IDX}"
EnvironmentFile       = ${SRC_DIR}/.env
ExecStart             = ${SRC_DIR}/run_agent.sh "/tmp/azp_agent_${AGENT_IDX}"

# Always restart, don't limit restarts at all, restart once per second
Restart               = always
RestartSec            = 1

[Install]
WantedBy              = default.target

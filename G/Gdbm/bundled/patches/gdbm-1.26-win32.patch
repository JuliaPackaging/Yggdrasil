diff -ru gdbm-1.26.orig/compat/Makefile.am gdbm-1.26/compat/Makefile.am
--- gdbm-1.26.orig/compat/Makefile.am	2025-03-06 10:51:59
+++ gdbm-1.26/compat/Makefile.am	2026-01-03 20:34:59
@@ -51,5 +51,5 @@
 
 libgdbm_compat_la_SOURCES = $(DBM_CF) $(NDBM_CF)
 
-libgdbm_compat_la_LDFLAGS = -version-info $(VI_CURRENT):$(VI_REVISION):$(VI_AGE)
+libgdbm_compat_la_LDFLAGS = -no-undefined -version-info $(VI_CURRENT):$(VI_REVISION):$(VI_AGE)
 
diff -ru gdbm-1.26.orig/compat/dbmopen.c gdbm-1.26/compat/dbmopen.c
--- gdbm-1.26.orig/compat/dbmopen.c	2025-03-06 10:51:59
+++ gdbm-1.26/compat/dbmopen.c	2026-01-03 20:34:59
@@ -57,13 +57,17 @@
 
 /* FIXME: revise return codes */
 static int
-ndbm_open_dir_file0 (const char *file_name, int pagfd, int mode)
+ndbm_open_dir_file0 (const char *file_name, struct gdbm_file_info *pag, int mode)
 {
   int fd = -1;
   struct stat st, pagst;
   unsigned char dirbuf[DEF_DIR_SIZE];
   int flags = (mode & GDBM_OPENMASK) == GDBM_READER ?
                 O_RDONLY : O_RDWR;
+  int pagfd = pag->desc;
+#ifdef _WIN32
+  HANDLE hFile;
+#endif
 
   if (mode & GDBM_CLOEXEC)
     flags |= O_CLOEXEC;
@@ -117,7 +121,7 @@
 	}
       else
 	{
-	  fd = open (file_name, flags);
+	  fd = open (file_name, flags | O_BINARY);
 	  if (fd == -1)
 	    {
 	      gdbm_set_errno (NULL, GDBM_FILE_OPEN_ERROR, FALSE);
@@ -156,7 +160,7 @@
     }
   
   /* File does not exist.  Create it. */
-  fd = open (file_name, flags | O_CREAT, pagst.st_mode & 0777);
+  fd = open (file_name, flags | O_CREAT | O_BINARY, pagst.st_mode & 0777);
   if (fd >= 0)
     {
       putint (dirbuf, GDBM_DIR_MAGIC);
@@ -176,10 +180,11 @@
 }
 
 static int
-ndbm_open_dir_file (const char *base, int pagfd, int mode)
+ndbm_open_dir_file (const char *base, struct gdbm_file_info *pag, int mode)
 {
   char *file_name = malloc (strlen (base) + sizeof (DIRSUF));
   int fd;
+  int pagfd = pag->desc;
   
   if (!file_name)
     {
@@ -187,7 +192,7 @@
       return -1;
     }
   fd = ndbm_open_dir_file0 (strcat (strcpy (file_name, base), DIRSUF),
-			    pagfd, mode);
+			    pag, mode);
   free (file_name);
   return fd;
 }
@@ -280,7 +285,7 @@
     }
   else
     {
-      dbm->dirfd = ndbm_open_dir_file (file, dbm->file->desc, open_flags);
+      dbm->dirfd = ndbm_open_dir_file (file, dbm->file, open_flags);
       if (dbm->dirfd == -1)
 	{
 	  gdbm_close (dbm->file);
Only in gdbm-1.26/compat: dbmopen.c.rej
diff -ru gdbm-1.26.orig/configure.ac gdbm-1.26/configure.ac
--- gdbm-1.26.orig/configure.ac	2025-07-30 05:46:20
+++ gdbm-1.26/configure.ac	2026-01-03 20:34:59
@@ -218,6 +218,13 @@
 
 AM_CONDITIONAL([COND_GDBMTOOL_DEBUG], [test "$want_gdbmtool_debug" = yes])
 
+if test x$host_os = xmingw32
+then
+  AM_CONDITIONAL(WIN32, true)
+else
+  AM_CONDITIONAL(WIN32, false)
+fi
+
 # Initialize the test suite.
 AC_CONFIG_TESTDIR(tests)
 AC_CONFIG_FILES([tests/Makefile tests/atlocal po/Makefile.in])
diff -ru gdbm-1.26.orig/src/Makefile.am gdbm-1.26/src/Makefile.am
--- gdbm-1.26.orig/src/Makefile.am	2025-03-09 05:50:57
+++ gdbm-1.26/src/Makefile.am	2026-01-05 11:54:12
@@ -69,5 +69,7 @@
   libgdbm_la_SOURCES += debug.c
 endif
 
-libgdbm_la_LDFLAGS = -version-info $(VI_CURRENT):$(VI_REVISION):$(VI_AGE)
+libgdbm_la_LDFLAGS = -no-undefined -version-info $(VI_CURRENT):$(VI_REVISION):$(VI_AGE)
+
+libgdbm_la_LIBADD = -lws2_32
 
diff -ru gdbm-1.26.orig/src/fullio.c gdbm-1.26/src/fullio.c
--- gdbm-1.26.orig/src/fullio.c	2025-04-11 04:58:48
+++ gdbm-1.26/src/fullio.c	2026-01-03 20:34:59
@@ -84,7 +84,13 @@
 int
 _gdbm_file_extend (GDBM_FILE dbf, off_t size)
 {
+#ifdef _WIN32
+  SYSTEM_INFO si;
+  GetSystemInfo(&si);
+  size_t page_size = si.dwPageSize;
+#else
   size_t page_size = sysconf (_SC_PAGESIZE);
+#endif
   char *buf;
   off_t file_end;
 
diff -ru gdbm-1.26.orig/src/gdbmdump.c gdbm-1.26/src/gdbmdump.c
--- gdbm-1.26.orig/src/gdbmdump.c	2025-03-09 05:50:57
+++ gdbm-1.26/src/gdbmdump.c	2026-01-03 20:34:59
@@ -17,8 +17,6 @@
 # include "autoconf.h"
 # include "gdbmdefs.h"
 # include "gdbm.h"
-# include <pwd.h>
-# include <grp.h>
 # include <time.h>
 
 static int
@@ -56,8 +54,6 @@
   time_t t;
   int fd;
   struct stat st;
-  struct passwd *pw;
-  struct group *gr;
   datum key;
   size_t count = 0;
   unsigned char *buffer = NULL;
@@ -76,13 +72,7 @@
 
   fprintf (fp, "#:file=%s\n", dbf->name);
   fprintf (fp, "#:uid=%lu,", (unsigned long) st.st_uid);
-  pw = getpwuid (st.st_uid);
-  if (pw)
-    fprintf (fp, "user=%s,", pw->pw_name);
   fprintf (fp, "gid=%lu,", (unsigned long) st.st_gid);
-  gr = getgrgid (st.st_gid);
-  if (gr)
-    fprintf (fp, "group=%s,", gr->gr_name);
   fprintf (fp, "mode=%03o\n", st.st_mode & 0777);
   fprintf (fp, "#:format=%s\n", dbf->xheader ? "numsync" : "standard");
   fprintf (fp, "# End of header\n");
@@ -179,7 +169,7 @@
   switch (open_flags)
     {
     case GDBM_WRCREAT:
-      nfd = open (filename, O_WRONLY | O_CREAT | O_EXCL, mode);
+      nfd = open (filename, O_WRONLY | O_BINARY | O_CREAT | O_EXCL, mode);
       if (nfd == -1)
 	{
 	  GDBM_SET_ERRNO (NULL, GDBM_FILE_OPEN_ERROR, FALSE);
@@ -187,7 +177,7 @@
 	}
       break;
     case GDBM_NEWDB:
-      nfd = open (filename, O_WRONLY | O_CREAT | O_TRUNC, mode);
+      nfd = open (filename, O_WRONLY | O_BINARY | O_CREAT | O_TRUNC, mode);
       if (nfd == -1)
 	{
 	  GDBM_SET_ERRNO (NULL, GDBM_FILE_OPEN_ERROR, FALSE);
diff -ru gdbm-1.26.orig/src/gdbmexp.c gdbm-1.26/src/gdbmexp.c
--- gdbm-1.26.orig/src/gdbmexp.c	2025-03-09 05:50:57
+++ gdbm-1.26/src/gdbmexp.c	2026-01-03 20:34:59
@@ -18,7 +18,11 @@
 
 /* Include system configuration before all else. */
 # include "autoconf.h"
+#ifdef _WIN32
+# include <winsock2.h>
+#else
 # include <arpa/inet.h>
+#endif
 
 #ifdef GDBM_EXPORT_18
 # define GDBM_SET_ERRNO(dbf, ec, fatal) gdbm_errno = ec
@@ -108,7 +112,7 @@
   switch (flags)
     {
     case GDBM_WRCREAT:
-      nfd = open (exportfile, O_WRONLY | O_CREAT | O_EXCL, mode);
+      nfd = open (exportfile, O_WRONLY | O_BINARY | O_CREAT | O_EXCL, mode);
       if (nfd == -1)
 	{
 	  GDBM_SET_ERRNO (NULL, GDBM_FILE_OPEN_ERROR, FALSE);
@@ -116,7 +120,7 @@
 	}
       break;
     case GDBM_NEWDB:
-      nfd = open (exportfile, O_WRONLY | O_CREAT | O_TRUNC, mode);
+      nfd = open (exportfile, O_WRONLY | O_BINARY | O_CREAT | O_TRUNC, mode);
       if (nfd == -1)
 	{
 	  GDBM_SET_ERRNO (NULL, GDBM_FILE_OPEN_ERROR, FALSE);
@@ -132,7 +136,7 @@
       return -1;
   }
 
-  fp = fdopen (nfd, "w");
+  fp = fdopen (nfd, "wb");
   if (!fp)
     {
       close (nfd);
diff -ru gdbm-1.26.orig/src/gdbmimp.c gdbm-1.26/src/gdbmimp.c
--- gdbm-1.26.orig/src/gdbmimp.c	2025-03-09 05:50:57
+++ gdbm-1.26/src/gdbmimp.c	2026-01-03 20:34:59
@@ -17,7 +17,11 @@
    along with GDBM. If not, see <http://www.gnu.org/licenses/>.   */
 
 # include "autoconf.h"
+#ifdef _WIN32
+# include <winsock2.h>
+#else
 # include <arpa/inet.h>
+#endif
 # include <limits.h>
 
 # include "gdbmdefs.h"
diff -ru gdbm-1.26.orig/src/gdbmload.c gdbm-1.26/src/gdbmload.c
--- gdbm-1.26.orig/src/gdbmload.c	2025-03-21 08:43:02
+++ gdbm-1.26/src/gdbmload.c	2026-01-03 20:34:59
@@ -18,8 +18,6 @@
 # include "gdbmdefs.h"
 # include "gdbm.h"
 # include <sys/types.h>
-# include <pwd.h>
-# include <grp.h>
 
 struct datbuf
 {
@@ -299,13 +297,12 @@
 _set_gdbm_meta_info (GDBM_FILE dbf, char *param, int meta_mask)
 {
   unsigned long n;
-  uid_t owner_uid;
-  uid_t owner_gid;
   mode_t mode;
   int meta_flags = 0;
   const char *p;
   char *end;
 
+#if 0
   if (!(meta_mask & GDBM_META_MASK_OWNER))
     {
       p = getparm (param, "user");
@@ -351,6 +348,7 @@
 	    }
 	}
     }
+#endif
   
   if (!(meta_mask & GDBM_META_MASK_MODE))
     {
@@ -367,6 +365,7 @@
 	}
     }
   
+#if 0 
   if (meta_flags)
     {
       int fd = gdbm_fdesc (dbf);
@@ -397,6 +396,7 @@
 	  return 1;
 	}
     }
+#endif
   return 0;
 }
 
diff -ru gdbm-1.26.orig/src/gdbmopen.c gdbm-1.26/src/gdbmopen.c
--- gdbm-1.26.orig/src/gdbmopen.c	2025-03-09 05:50:57
+++ gdbm-1.26/src/gdbmopen.c	2026-01-03 20:34:59
@@ -23,7 +23,7 @@
 #include <stddef.h>
 
 static void
-compute_directory_size (blksize_t block_size,
+compute_directory_size (ssize_t block_size,
 			int *ret_dir_size, int *ret_dir_bits)
 {
   /* Create the initial hash table directory.  */
@@ -225,7 +225,7 @@
   return ftruncate (dbf->desc, 0);
 #else
   int fd;
-  fd = open (dbf->name, O_RDWR|O_TRUNC, mode);
+  fd = open (dbf->name, O_RDWR|O_TRUNC|O_BINARY, mode);
   if (fd == -1)
     return -1;
   return close (fd);
@@ -300,6 +300,8 @@
       if (flags & GDBM_CLOEXEC)
 	fbits |= O_CLOEXEC;
 
+      fbits |= O_BINARY;
+
       fd = open (file_name, fbits, op->mode);
       if (fd < 0)
 	{
@@ -464,8 +466,7 @@
 	      if (!(flags & GDBM_CLOERROR))
 		dbf->desc = -1;
 	      gdbm_close (dbf);
-	      GDBM_SET_ERRNO2 (NULL, GDBM_BLOCK_SIZE_ERROR, FALSE,
-			       GDBM_DEBUG_OPEN);
+	      GDBM_SET_ERRNO2 (NULL, GDBM_BLOCK_SIZE_ERROR, FALSE,GDBM_DEBUG_OPEN);
 	      return NULL;
 	    }
 	  else
diff -ru gdbm-1.26.orig/src/gdbmsync.c gdbm-1.26/src/gdbmsync.c
--- gdbm-1.26.orig/src/gdbmsync.c	2025-03-09 05:50:57
+++ gdbm-1.26/src/gdbmsync.c	2026-01-03 20:34:59
@@ -440,6 +440,8 @@
       GDBM_SET_ERRNO (dbf, GDBM_FILE_SYNC_ERROR, TRUE);
       r = 1;
     }
+#elif _WIN32
+  FlushFileBuffers(dbf);
 #else
   sync ();
   sync ();
diff -ru gdbm-1.26.orig/src/lock.c gdbm-1.26/src/lock.c
--- gdbm-1.26.orig/src/lock.c	2025-04-11 01:35:20
+++ gdbm-1.26/src/lock.c	2026-01-03 21:06:37
@@ -25,7 +25,7 @@
 #include <signal.h>
 #include <errno.h>
 
-#if HAVE_FLOCK
+#if HAVE_FLOCK || defined(_WIN32)
 # ifndef LOCK_SH
 #  define LOCK_SH 1
 # endif
@@ -43,6 +43,83 @@
 # endif
 #endif
 
+#ifdef _WIN32
+#include <errno.h>
+#include <limits.h>
+
+/*
+ * flock support code for windows
+ *
+ * This code is derived from ruby (http://www.ruby-lang.org/).
+ * Original copyright notice is below.
+ */
+/*
+ *  Copyright (c) 1993, Intergraph Corporation
+ *
+ *  You may distribute under the terms of either the GNU General Public
+ *  License or the Artistic License, as specified in the perl README file.
+ *
+ *  Various Unix compatibility functions and NT specific functions.
+ *
+ *  Some of this code was derived from the MSDOS port(s) and the OS/2 port.
+ *
+ */
+
+#ifndef EWOULDBLOCK
+#define EWOULDBLOCK 10035 /* EBASEERR + 35 (winsock.h) */
+#endif
+
+#define LK_ERR(f,i) ((f) ? (i = 0) : (errno = GetLastError() == ERROR_LOCK_VIOLATION ? EWOULDBLOCK : EACCES))
+#define LK_LEN      ULONG_MAX
+
+static int
+flock_winnt(HANDLE fh, int oper)
+{
+    OVERLAPPED o;
+    int i = -1;
+
+    memset(&o, 0, sizeof(o));
+
+    switch(oper) {
+      case LOCK_SH:		/* shared lock */
+	LK_ERR(LockFileEx(fh, 0, 0, LK_LEN, LK_LEN, &o), i);
+	break;
+      case LOCK_EX:		/* exclusive lock */
+	LK_ERR(LockFileEx(fh, LOCKFILE_EXCLUSIVE_LOCK, 0, LK_LEN, LK_LEN, &o), i);
+	break;
+      case LOCK_SH|LOCK_NB:	/* non-blocking shared lock */
+	LK_ERR(LockFileEx(fh, LOCKFILE_FAIL_IMMEDIATELY, 0, LK_LEN, LK_LEN, &o), i);
+	break;
+      case LOCK_EX|LOCK_NB:	/* non-blocking exclusive lock */
+	LK_ERR(LockFileEx(fh,
+			  LOCKFILE_EXCLUSIVE_LOCK|LOCKFILE_FAIL_IMMEDIATELY,
+			  0, LK_LEN, LK_LEN, &o), i);
+	break;
+      case LOCK_UN:		/* unlock lock */
+	LK_ERR(UnlockFileEx(fh, 0, LK_LEN, LK_LEN, &o), i);
+	break;
+      default:            /* unknown */
+	errno = EINVAL;
+	break;
+    }
+    return i;
+}
+
+#undef LK_ERR
+
+int
+flock(int fd, int oper)
+{
+    static int (*locker)(HANDLE, int) = NULL;
+
+    if (!locker) {
+	locker = flock_winnt;
+    }
+
+    return locker((HANDLE)_get_osfhandle(fd), oper);
+}
+#endif /* _WIN32 */
+
 #if defined(F_SETLK) && defined(F_RDLCK) && defined(F_WRLCK)
 # define HAVE_FCNTL_LOCK 1
 #else
@@ -66,7 +143,7 @@
 static int
 try_lock_flock (GDBM_FILE dbf, int nb)
 {
-#if HAVE_FLOCK
+#if HAVE_FLOCK || defined(_WIN32)
   if (flock (dbf->desc,
 	     ((dbf->read_write == GDBM_READER) ? LOCK_SH : LOCK_EX)
 	     | (nb ? LOCK_NB : 0)) == 0)
@@ -84,7 +161,7 @@
 static void
 unlock_flock (GDBM_FILE dbf)
 {
-#if HAVE_FLOCK
+#if HAVE_FLOCK || defined(_WIN32)
   flock (dbf->desc, LOCK_UN);
 #endif
 }
@@ -305,6 +382,7 @@
 _gdbm_lockwait_signal (GDBM_FILE dbf, struct timespec const *ts)
 {
   int ret = -1;
+#if !defined(_WIN32)
   int ec = 0;
 
   if (ts == NULL || (ts->tv_sec == 0 && ts->tv_nsec == 0))
@@ -358,6 +436,7 @@
     }
   if (ret != 0)
     errno = ec;
+#endif
   return ret;
 }
 
diff -ru gdbm-1.26.orig/src/recover.c gdbm-1.26/src/recover.c
--- gdbm-1.26.orig/src/recover.c	2025-03-09 05:50:57
+++ gdbm-1.26/src/recover.c	2026-01-03 20:34:59
@@ -19,6 +19,20 @@
 
 #define TMPSUF ".XXXXXX"
 
+#if !HAVE_RENAME
+#if defined(_WIN32)
+static int
+_gdbm_rename (char *old_name, char *new_name)
+{
+  if (!MoveFileEx (old_name, new_name, MOVEFILE_REPLACE_EXISTING))
+    return -1;
+
+  return 0;
+}
+#define rename _gdbm_rename
+#endif
+#endif
+
 int
 gdbm_copy_meta (GDBM_FILE dst, GDBM_FILE src)
 {
@@ -29,16 +43,20 @@
       GDBM_SET_ERRNO (src, GDBM_FILE_STAT_ERROR, src->need_recovery);
       return -1;
     }
+#if HAVE_FCHOWN
   if (fchown (dst->desc, st.st_uid, st.st_gid))
     {
       GDBM_SET_ERRNO (dst, GDBM_ERR_FILE_OWNER, dst->need_recovery);
       return -1;
     }
+#endif
+#if HAVE_FCHMOD
   if (fchmod (dst->desc, st.st_mode & 0777))
     {
       GDBM_SET_ERRNO (dst, GDBM_ERR_FILE_MODE, dst->need_recovery);
       return -1;
     }
+#endif
   return 0;
 }
 
@@ -132,18 +150,34 @@
     _gdbm_cache_init (new_dbf, dbf->cache_size);
   
   /* Move the new file to old name. */
+#ifdef _WIN32
+  close (new_dbf->desc);
 
+  if (dbf->file_locking)
+    {
+      _gdbm_unlock_file (dbf);
+    }
+  close (dbf->desc);
+#endif
   if (rename (new_dbf->name, dbf->name) != 0)
     {
       GDBM_SET_ERRNO (NULL, GDBM_REORGANIZE_FAILED, FALSE);
+#ifdef _WIN32
+      dbf->desc = open (dbf->name, O_RDWR|O_BINARY, 0);
+      new_dbf->desc = open (new_dbf->name, O_RDWR|O_BINARY, 0);
+#endif
       gdbm_close (new_dbf);
       return -1;
     }
 
   /* Fix up DBF to have the correct information for the new file. */
+#ifdef _WIN32
+  new_dbf->desc = open (dbf->name, O_RDWR|O_BINARY, 0);
+#else
   if (dbf->file_locking)
     _gdbm_unlock_file (dbf);
   close (dbf->desc);
+#endif
   free (dbf->header);
   free (dbf->dir);
 
diff -ru gdbm-1.26.orig/src/systems.h gdbm-1.26/src/systems.h
--- gdbm-1.26.orig/src/systems.h	2025-07-24 01:20:00
+++ gdbm-1.26/src/systems.h	2026-01-03 20:34:59
@@ -17,6 +17,11 @@
    along with GDBM. If not, see <http://www.gnu.org/licenses/>.    */
 
 /* Include all system headers first. */
+#ifdef _WIN32
+# undef _WIN32_WINNT
+# define _WIN32_WINNT 0x0601
+# include <windows.h>
+#endif
 #include <sys/types.h>
 #include <stdio.h>
 #include <stddef.h>
@@ -44,6 +49,10 @@
 # define O_CLOEXEC 0
 #endif
 
+#ifndef O_BINARY
+# define O_BINARY 0
+#endif
+
 /* Default block size.  Some systems do not have blocksize in their
    stat record. This code uses the BSD blocksize from stat. */
 
@@ -64,4 +73,7 @@
 # define STDERR_FILENO 2
 #endif
 
-
+/* Windows port of flock */
+#ifdef _WIN32
+extern int flock(int fd, int oper);
+#endif
diff -ru gdbm-1.26.orig/tests/blocksize02.at gdbm-1.26/tests/blocksize02.at
--- gdbm-1.26.orig/tests/blocksize02.at	2025-03-06 10:57:50
+++ gdbm-1.26/tests/blocksize02.at	2026-01-03 20:34:59
@@ -22,7 +22,6 @@
 ],
 [1],
 [],
-[gdbm_open failed: Block size error
-])
+[gdbm_open failed: Block size error])
 
 AT_CLEANUP
diff -ru gdbm-1.26.orig/tests/dbmdel01.at gdbm-1.26/tests/dbmdel01.at
--- gdbm-1.26.orig/tests/dbmdel01.at	2025-03-06 10:57:50
+++ gdbm-1.26/tests/dbmdel01.at	2026-01-03 20:34:59
@@ -25,7 +25,7 @@
 ],
 [2],
 [],
-[dtdel: cannot delete 11: Item not found
+[dtdel.exe: cannot delete 11: Item not found
 ])
 
 AT_CLEANUP
diff -ru gdbm-1.26.orig/tests/dbmfetch01.at gdbm-1.26/tests/dbmfetch01.at
--- gdbm-1.26.orig/tests/dbmfetch01.at	2025-03-06 10:57:50
+++ gdbm-1.26/tests/dbmfetch01.at	2026-01-03 20:34:59
@@ -24,7 +24,7 @@
 ],
 [2],
 [],
-[dtfetch: 0: not found
+[dtfetch.exe: 0: not found
 ])
 
 AT_CLEANUP
diff -ru gdbm-1.26.orig/tests/delete01.at gdbm-1.26/tests/delete01.at
--- gdbm-1.26.orig/tests/delete01.at	2025-03-06 10:57:50
+++ gdbm-1.26/tests/delete01.at	2026-01-03 20:34:59
@@ -24,7 +24,7 @@
 ],
 [2],
 [],
-[gtdel: cannot delete 11: Item not found
+[gtdel.exe: cannot delete 11: Item not found
 ])
 
 AT_CLEANUP
diff -ru gdbm-1.26.orig/tests/dtdel.c gdbm-1.26/tests/dtdel.c
--- gdbm-1.26.orig/tests/dtdel.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/dtdel.c	2026-01-03 20:34:59
@@ -16,6 +16,7 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <string.h>
 #include "dbm.h"
@@ -30,7 +31,12 @@
   int flags = 0;
   int data_z = 0;
   int rc = 0;
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+  _setmode(_fileno(stderr), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/dtdump.c gdbm-1.26/tests/dtdump.c
--- gdbm-1.26.orig/tests/dtdump.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/dtdump.c	2026-01-03 20:34:59
@@ -16,10 +16,13 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <string.h>
 #include "dbm.h"
 #include "progname.h"
+#include "../src/gdbm.h"
+#include "../compat/dbm.h"
 
 int
 main (int argc, char **argv)
@@ -29,7 +32,12 @@
   datum key;
   datum data;
   int delim = '\t';
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+  _setmode(_fileno(stderr), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/dtfetch.c gdbm-1.26/tests/dtfetch.c
--- gdbm-1.26.orig/tests/dtfetch.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/dtfetch.c	2026-01-03 20:34:59
@@ -16,6 +16,7 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <string.h>
 #include "dbm.h"
@@ -44,7 +45,12 @@
   int data_z = 0;
   int delim = 0;
   int rc = 0;
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+  _setmode(_fileno(stderr), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/dtload.c gdbm-1.26/tests/dtload.c
--- gdbm-1.26.orig/tests/dtload.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/dtload.c	2026-01-03 20:34:59
@@ -16,6 +16,7 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
@@ -39,7 +40,13 @@
   datum data;
   int delim = '\t';
   int data_z = 0;
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdin), O_BINARY);
+  _setmode(_fileno(stdout), O_BINARY);
+  _setmode(_fileno(stderr), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/fetch01.at gdbm-1.26/tests/fetch01.at
--- gdbm-1.26.orig/tests/fetch01.at	2025-03-06 10:57:50
+++ gdbm-1.26/tests/fetch01.at	2026-01-03 20:34:59
@@ -23,7 +23,7 @@
 ],
 [2],
 [],
-[gtfetch: 0: not found
+[gtfetch.exe: 0: not found
 ])
 
 AT_CLEANUP
diff -ru gdbm-1.26.orig/tests/gdbmtool03.at gdbm-1.26/tests/gdbmtool03.at
--- gdbm-1.26.orig/tests/gdbmtool03.at	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gdbmtool03.at	2026-01-03 20:34:59
@@ -17,12 +17,13 @@
 AT_SETUP([Initialization file])
 AT_KEYWORDS([gdbmtool])
 AT_CHECK([
-AT_DATA([.gdbmtoolrc],
-[open t.db
-])
-gdbmtool <<EOT
+AT_DATA([.gdbmtoolrc],[
+open t.db
 status
+quit
 EOT
+])
+gdbmtool < .gdbmtoolrc
 ],
 [0],
 [Database file: t.db
diff -ru gdbm-1.26.orig/tests/gtdel.c gdbm-1.26/tests/gtdel.c
--- gdbm-1.26.orig/tests/gtdel.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gtdel.c	2026-01-03 20:34:59
@@ -16,6 +16,7 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <string.h>
 #include <errno.h>
@@ -32,7 +33,12 @@
   GDBM_FILE dbf;
   int data_z = 0;
   int rc = 0;
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+  _setmode(_fileno(stderr), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/gtdump.c gdbm-1.26/tests/gtdump.c
--- gdbm-1.26.orig/tests/gtdump.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gtdump.c	2026-01-03 20:34:59
@@ -17,6 +17,7 @@
 #include "autoconf.h"
 #include <stdio.h>
 #include <stdlib.h>
+#include <fcntl.h>
 #include <string.h>
 #include <errno.h>
 #include "gdbm.h"
@@ -32,7 +33,12 @@
   int flags = 0;
   GDBM_FILE dbf;
   int delim = '\t';
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdin), O_BINARY);
+  _setmode(_fileno(stdout), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/gtfetch.c gdbm-1.26/tests/gtfetch.c
--- gdbm-1.26.orig/tests/gtfetch.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gtfetch.c	2026-01-03 20:34:59
@@ -16,6 +16,7 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <string.h>
 #include <errno.h>
@@ -47,7 +48,12 @@
   int data_z = 0;
   int delim = 0;
   int rc = 0;
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+  _setmode(_fileno(stderr), O_BINARY);
+#endif
+
   while (--argc)
     {
       char *arg = *++argv;
diff -ru gdbm-1.26.orig/tests/gtload.c gdbm-1.26/tests/gtload.c
--- gdbm-1.26.orig/tests/gtload.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gtload.c	2026-01-03 20:34:59
@@ -16,6 +16,7 @@
 */
 #include "autoconf.h"
 #include <stdio.h>
+#include <fcntl.h>
 #include <stdlib.h>
 #include <stdarg.h>
 #include <string.h>
@@ -102,6 +103,11 @@
 #ifdef GDBM_DEBUG_ENABLE
   gdbm_debug_printer = debug_printer;
 #endif
+
+#ifdef _WIN32
+  _setmode(_fileno(stdin), O_BINARY);
+  _setmode(_fileno(stdout), O_BINARY);
+#endif
   
   while (--argc)
     {
@@ -203,7 +209,7 @@
   dbf = gdbm_open (dbname, block_size, mode|flags, 00664, NULL);
   if (!dbf)
     {
-      fprintf (stderr, "gdbm_open failed: %s\n", gdbm_strerror (gdbm_errno));
+      fprintf (stderr, "gdbm_open failed: %s", gdbm_strerror (gdbm_errno));
       exit (1);
     }
 
diff -ru gdbm-1.26.orig/tests/gtopt.c gdbm-1.26/tests/gtopt.c
--- gdbm-1.26.orig/tests/gtopt.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gtopt.c	2026-01-03 20:34:59
@@ -178,7 +178,11 @@
 int
 test_maxmapsize (void *valptr)
 {
+#ifdef _SC_PAGESIZE
   size_t page_size = sysconf (_SC_PAGESIZE);
+#else
+  size_t page_size = 4096;
+#endif
   size_t expected_size = ((mapped_size_max + page_size - 1) / page_size) *
 	                          page_size;
   return (*(size_t*) valptr == expected_size) ? RES_PASS : RES_FAIL;
@@ -308,7 +312,11 @@
 {
   GDBM_FILE dbf;
   struct optest *op;
-  
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+#endif
+
   progname = canonical_progname (argv[0]);
   while (--argc)
     {
diff -ru gdbm-1.26.orig/tests/gtver.c gdbm-1.26/tests/gtver.c
--- gdbm-1.26.orig/tests/gtver.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/gtver.c	2026-01-03 20:34:59
@@ -17,6 +17,7 @@
 #include "autoconf.h"
 #include <stdlib.h>
 #include <stdio.h>
+#include <fcntl.h>
 #include <string.h>
 #include "gdbm.h"
 #include "progname.h"
@@ -30,6 +31,10 @@
 {
   const char *progname = canonical_progname (argv[0]);
   int library = 0;
+
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+#endif
 
   if (argc == 1)
     {
diff -ru gdbm-1.26.orig/tests/num2word.c gdbm-1.26/tests/num2word.c
--- gdbm-1.26.orig/tests/num2word.c	2025-03-06 10:57:50
+++ gdbm-1.26/tests/num2word.c	2026-01-03 20:34:59
@@ -17,6 +17,7 @@
 #include "autoconf.h"
 #include <stdlib.h>
 #include <stdio.h>
+#include <fcntl.h>
 #include <string.h>
 #include <unistd.h>
 #include <errno.h>
@@ -322,6 +323,10 @@
 int
 main (int argc, char **argv)
 {
+#ifdef _WIN32
+  _setmode(_fileno(stdout), O_BINARY);
+#endif
+
   progname = *argv++;
   --argc;
 
@@ -397,10 +402,10 @@
   
   if (random_option)
     {
-      srandom (time (NULL));
+      srand (time (NULL));
       while (range_total)
 	{
-	  numeral_t n = range_get (random () % range_total);
+	  numeral_t n = range_get (rand () % range_total);
 	  print_number (n);
 	}
     }
diff -ru gdbm-1.26.orig/tests/testsuite gdbm-1.26/tests/testsuite
--- gdbm-1.26.orig/tests/testsuite	2025-07-30 06:18:33
+++ gdbm-1.26/tests/testsuite	2026-01-03 20:34:59
@@ -2187,7 +2187,7 @@
 ) >>"$at_stdout" 2>>"$at_stderr" 5>&-
 at_status=$? at_failed=false
 $at_check_filter
-echo >>"$at_stderr"; printf "%s\n" "gtfetch: 0: not found
+echo >>"$at_stderr"; printf "%s\n" "gtfetch.exe: 0: not found
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 at_fn_diff_devnull "$at_stdout" || at_failed=:
@@ -2283,7 +2283,7 @@
 ) >>"$at_stdout" 2>>"$at_stderr" 5>&-
 at_status=$? at_failed=false
 $at_check_filter
-echo >>"$at_stderr"; printf "%s\n" "gtdel: cannot delete 11: Item not found
+echo >>"$at_stderr"; printf "%s\n" "gtdel.exe: cannot delete 11: Item not found
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 at_fn_diff_devnull "$at_stdout" || at_failed=:
@@ -2795,7 +2795,7 @@
 ) >>"$at_stdout" 2>>"$at_stderr" 5>&-
 at_status=$? at_failed=false
 $at_check_filter
-echo >>"$at_stderr"; printf "%s\n" "dtfetch: 0: not found
+echo >>"$at_stderr"; printf "%s\n" "dtfetch.exe: 0: not found
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 at_fn_diff_devnull "$at_stdout" || at_failed=:
@@ -3003,7 +3003,7 @@
 ) >>"$at_stdout" 2>>"$at_stderr" 5>&-
 at_status=$? at_failed=false
 $at_check_filter
-echo >>"$at_stderr"; printf "%s\n" "dtdel: cannot delete 11: Item not found
+echo >>"$at_stderr"; printf "%s\n" "dtdel.exe: cannot delete 11: Item not found
 " | \
   $at_diff - "$at_stderr" || at_failed=:
 at_fn_diff_devnull "$at_stdout" || at_failed=:
diff -ru gdbm-1.26.orig/tools/gdbm_load.c gdbm-1.26/tools/gdbm_load.c
--- gdbm-1.26.orig/tools/gdbm_load.c	2025-03-06 10:51:59
+++ gdbm-1.26/tools/gdbm_load.c	2026-01-05 12:28:32
@@ -18,16 +18,12 @@
 # include "gdbm.h"
 # include "gdbmapp.h"
 # include "gdbmdefs.h"
-# include <pwd.h>
-# include <grp.h>
 
 int replace = 0;
 int meta_mask = 0;
 int no_meta_option;
 
 int mode;
-uid_t owner_uid;
-gid_t owner_gid;
 
 char *parseopt_program_doc = N_("load a GDBM database from a file");
 char *parseopt_program_args = N_("FILE [DB_FILE]");
@@ -50,6 +46,7 @@
     {
       int fd = gdbm_fdesc (dbf);
 
+#if 0
       if (meta_mask & GDBM_META_MASK_OWNER)
 	{
 	  if (fchown (fd, owner_uid, owner_gid))
@@ -63,6 +60,7 @@
 	  GDBM_SET_ERRNO (dbf, GDBM_ERR_FILE_OWNER, FALSE);
 	  return 1;
 	}
+#endif
     }
   return 0;
 }
@@ -144,6 +142,7 @@
 	oflags = (oflags & ~GDBM_OPENMASK) | GDBM_WRCREAT;
 	break;
 
+#if 0
       case 'u':
 	{
 	  size_t len;
@@ -208,6 +207,7 @@
 	  meta_mask |= GDBM_META_MASK_OWNER;
 	}
 	break;
+#endif
 	  
       case 'r':
 	replace = 1;
Only in gdbm-1.26/tools: gdbm_load.c~
diff -ru gdbm-1.26.orig/tools/gdbmshell.c gdbm-1.26/tools/gdbmshell.c
--- gdbm-1.26.orig/tools/gdbmshell.c	2025-03-21 08:45:05
+++ gdbm-1.26/tools/gdbmshell.c	2026-01-05 12:14:04
@@ -21,12 +21,7 @@
 #include <errno.h>
 #include <ctype.h>
 #include <signal.h>
-#include <pwd.h>
-#include <sys/ioctl.h>
-#include <sys/wait.h>
 #include <sys/time.h>
-#include <sys/resource.h>
-#include <termios.h>
 #include <stdarg.h>
 #ifdef HAVE_LOCALE_H
 # include <locale.h>
@@ -1048,19 +1043,13 @@
   char *s = buf;
   *s++ = mode & S_IRUSR ? 'r' : '-';
   *s++ = mode & S_IWUSR ? 'w' : '-';
-  *s++ = (mode & S_ISUID
-	       ? (mode & S_IXUSR ? 's' : 'S')
-	       : (mode & S_IXUSR ? 'x' : '-'));
+  *s++ = mode & S_IXUSR ? 'x' : '-';
   *s++ = mode & S_IRGRP ? 'r' : '-';
   *s++ = mode & S_IWGRP ? 'w' : '-';
-  *s++ = (mode & S_ISGID
-	       ? (mode & S_IXGRP ? 's' : 'S')
-	       : (mode & S_IXGRP ? 'x' : '-'));
+  *s++ = mode & S_IXGRP ? 'x' : '-';
   *s++ = mode & S_IROTH ? 'r' : '-';
   *s++ = mode & S_IWOTH ? 'w' : '-';
-  *s++ = (mode & S_ISVTX
-	       ? (mode & S_IXOTH ? 't' : 'T')
-	       : (mode & S_IXOTH ? 'x' : '-'));
+  *s++ = mode & S_IXOTH ? 'x' : '-';
   *s = '\0';
   return buf;
 }
@@ -1919,54 +1908,7 @@
 shell_handler (struct command_param *param,
 	       struct command_environ *cenv GDBM_ARG_UNUSED)
 {
-  char *argv[4];
-  pid_t pid, rc;
-  int status;
-
-  argv[0] = getenv ("$SHELL");
-  if (!argv[0])
-    argv[0] = "/bin/sh";
-  if (param->vararg)
-    {
-      argv[1] = "-c";
-      argv[2] = param->vararg->v.string;
-      argv[3] = NULL;
-    }
-  else
-    {
-      argv[1] = NULL;
-    }
-
-  pid = fork ();
-  if (pid == -1)
-    {
-      terror ("fork: %s", strerror (errno));
-      return GDBMSHELL_ERR;
-    }
-  if (pid == 0)
-    {
-      execv (argv[0], argv);
-      perror (argv[0]);
-      _exit (127);
-    }
-
-  rc = waitpid (pid, &status, 0);
-  if (rc == -1)
-    {
-      terror ("waitpid: %s", strerror (errno));
-      rc = GDBMSHELL_ERR;
-    }
-  else if (!interactive ())
-    {
-      if (WIFEXITED (status))
-	{
-	  if (WEXITSTATUS (status) != 0)
-	    terror (_("command failed with status %d"), WEXITSTATUS (status));
-	}
-      else if (WIFSIGNALED (status))
-	terror (_("command terminated on signal %d"), WTERMSIG (status));
-    }
-  return rc;
+  return -1;
 }
 
 static int
@@ -3095,11 +3037,10 @@
 void
 timing_start (struct timing *t)
 {
-  struct rusage r;
   gettimeofday (&t->real, NULL);
-  getrusage (RUSAGE_SELF, &r);
-  t->user  = r.ru_utime;
-  t->sys = r.ru_stime;
+  t->user = t->real;
+  t->sys.tv_sec = 0;
+  t->sys.tv_usec = 0;
 }
 
 static inline struct timeval
@@ -3121,14 +3062,13 @@
 void
 timing_stop (struct timing *t)
 {
-  struct rusage r;
   struct timeval now;
 
   gettimeofday (&now, NULL);
-  getrusage (RUSAGE_SELF, &r);
   t->real = timeval_sub (now, t->real);
-  t->user = timeval_sub (r.ru_utime, t->user);
-  t->sys = timeval_sub (r.ru_stime, t->sys);
+  t->user = t->real;
+  t->sys.tv_sec = 0;
+  t->sys.tv_usec = 0;
 }
 
 #ifndef HAVE_GETLINE
@@ -3359,12 +3299,6 @@
       rc = input_context_push (instream);
       if (rc == 0)
 	{
-	  struct sigaction act, old_act;
-
-	  act.sa_flags = 0;
-	  sigemptyset(&act.sa_mask);
-	  act.sa_handler = SIG_IGN;
-	  sigaction (SIGPIPE, &act, &old_act);
 	  /* Welcome message. */
 	  if (instream_interactive (instream) && !variable_is_true ("quiet"))
 	    printf (_("\nWelcome to the gdbm tool.  Type ? for help.\n\n"));
@@ -3372,7 +3306,6 @@
 	  input_context_drain ();
 	  yylex_destroy ();
 	  closedb ();
-	  sigaction (SIGPIPE, &old_act, NULL);
 	}
       else
 	instream_close (instream);
Only in gdbm-1.26/tools: gdbmshell.c~
diff -ru gdbm-1.26.orig/tools/gdbmtool.c gdbm-1.26/tools/gdbmtool.c
--- gdbm-1.26.orig/tools/gdbmtool.c	2025-03-06 10:51:59
+++ gdbm-1.26/tools/gdbmtool.c	2026-01-05 12:06:48
@@ -18,10 +18,6 @@
 #include <errno.h>
 #include <ctype.h>
 #include <signal.h>
-#include <pwd.h>
-#include <sys/ioctl.h>
-#include <sys/wait.h>
-#include <termios.h>
 #include <stdarg.h>
 #ifdef HAVE_LOCALE_H
 # include <locale.h>
@@ -35,27 +31,6 @@
   if (access (GDBMTOOLRC, R_OK) == 0)
     {
       istr = instream_file_create (GDBMTOOLRC);
-    }
-  else
-    {
-      char *fname;
-      char *p = getenv ("HOME");
-      if (!p)
-	{
-	  struct passwd *pw = getpwuid (getuid ());
-	  if (!pw)
-	    {
-	      terror (_("cannot find home directory"));
-	      return;
-	    }
-	  p = pw->pw_dir;
-	}
-      fname = mkfilename (p, GDBMTOOLRC, NULL);
-      if (access (fname, R_OK) == 0)
-	{
-	  istr = instream_file_create (GDBMTOOLRC);
-	}
-      free (fname);
     }
 
   if (istr)
Only in gdbm-1.26/tools: gdbmtool.c~
diff -ru gdbm-1.26.orig/tools/util.c gdbm-1.26/tools/util.c
--- gdbm-1.26.orig/tools/util.c	2025-03-06 10:51:59
+++ gdbm-1.26/tools/util.c	2026-01-03 20:34:59
@@ -15,7 +15,6 @@
    along with GDBM. If not, see <http://www.gnu.org/licenses/>.    */
 
 #include "gdbmtool.h"
-#include <pwd.h>
 
 char *
 mkfilename (const char *dir, const char *file, const char *suf)
@@ -44,6 +43,7 @@
 char *
 tildexpand (char *s)
 {
+#if 0
   if (s[0] == '~')
     {
       char *p = s + 1;
@@ -64,6 +64,7 @@
       if (pw)
 	return mkfilename (pw->pw_dir, p + len + 1, NULL);
     }
+#endif
   return estrdup (s);
 }
 
diff -ru gdbm-1.26.orig/tools/wordwrap.c gdbm-1.26/tools/wordwrap.c
--- gdbm-1.26.orig/tools/wordwrap.c	2025-04-11 03:20:32
+++ gdbm-1.26/tools/wordwrap.c	2026-01-05 12:21:57
@@ -23,8 +23,7 @@
 #include <wchar.h>
 #include <errno.h>
 #include <limits.h>
-#include <termios.h>
-#include <sys/ioctl.h>
+#include <windows.h>
 
 #define UNSET ((unsigned)-1)
 #define ISSET(c) (c != UNSET)
@@ -110,27 +109,28 @@
 static unsigned
 detect_right_margin (WORDWRAP_FILE wf)
 {
-  struct winsize ws;
+  CONSOLE_SCREEN_BUFFER_INFO csbi;
   unsigned r = 0;
 
-  ws.ws_col = ws.ws_row = 0;
-  if ((ioctl (wf->fd, TIOCGWINSZ, (char *) &ws) < 0) || ws.ws_col == 0)
+  if (GetConsoleScreenBufferInfo (GetStdHandle (STD_OUTPUT_HANDLE), &csbi))
+    r = csbi.srWindow.Right  - csbi.srWindow.Left + 1;
+  else
     {
       char *p = getenv ("COLUMNS");
       if (p)
-	{
-	  unsigned long n;
-	  char *ep;
-	  errno = 0;
-	  n = strtoul (p, &ep, 10);
-	  if (!(errno || *ep || n > UINT_MAX))
-	    r = n;
-	}
+        {
+          unsigned long n;
+          char *ep;
+          errno = 0;
+          n = strtoul (p, &ep, 10);
+          if (!(errno || *ep || n > UINT_MAX))
+            r = n;
+          else
+            r = DEFAULT_RIGHT_MARGIN;
+        }
       else
-	r = DEFAULT_RIGHT_MARGIN;
+        r = DEFAULT_RIGHT_MARGIN;
     }
-  else
-    r = ws.ws_col;
   return r;
 }
 
Only in gdbm-1.26/tools: wordwrap.c~

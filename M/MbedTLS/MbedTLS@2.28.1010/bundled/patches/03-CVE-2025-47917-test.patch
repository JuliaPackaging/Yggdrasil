From 4050bc4f45a50cdbe1de353fee0db4b1f6352b5c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Manuel=20P=C3=A9gouri=C3=A9-Gonnard?=
 <manuel.pegourie-gonnard@arm.com>
Date: Wed, 21 May 2025 14:35:42 +0200
Subject: [PATCH] Add tests for bug in mbedtls_x509_string_to_names()
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

The commented out tests cause crashes (in different ways) until the bug
is fixed; the first two test are passing already and are here mostly to
provide a reference point.

The bug report was using programs/x509/cert_write, but string_to_names()
is what it was really targetting, which is better for automated tests.
The strings used are a minor adapation of those from the report.

Signed-off-by: Manuel Pégourié-Gonnard <manuel.pegourie-gonnard@arm.com>
---
 tests/suites/test_suite_x509write.data | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/tests/suites/test_suite_x509write.data b/tests/suites/test_suite_x509write.data
index 6bb81c7e78..59f93d24c9 100644
--- a/tests/suites/test_suite_x509write.data
+++ b/tests/suites/test_suite_x509write.data
@@ -141,3 +141,24 @@ x509_set_serial_check:
 
 Check max extension length
 x509_set_extension_length_check:
+
+# Note: the behaviour is incorrect, output from string->names->string should be
+# the same as the input, rather than just the last component, see
+# https://github.com/Mbed-TLS/mbedtls/issues/10189
+# Still including tests for the current incorrect behaviour because of the
+# variants below where we want to ensure at least that no memory corruption
+# happens (which would be a lot worse than just a functional bug).
+X509 String to Names (repeated OID)
+mbedtls_x509_string_to_names:"CN=ab,CN=cd,CN=ef":"CN=ef":0
+
+# Note: when a value starts with a # sign, it's treated as the hex encoding of
+# the DER encoding of the value. Here, 0400 is a zero-length OCTET STRING.
+# The tag actually doesn't matter for our purposes, only the length.
+X509 String to Names (repeated OID, 1st is zero-length)
+mbedtls_x509_string_to_names:"CN=#0400,CN=cd,CN=ef":"CN=ef":0
+
+#X509 String to Names (repeated OID, middle is zero-length)
+#mbedtls_x509_string_to_names:"CN=ab,CN=#0400,CN=ef":"CN=ef":0
+
+#X509 String to Names (repeated OID, last is zero-length)
+#mbedtls_x509_string_to_names:"CN=ab,CN=cd,CN=#0400":"CN=ef":0
-- 
2.39.5 (Apple Git-154)


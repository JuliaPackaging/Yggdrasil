From e9170a1b78524e32fb3f446e40d26c0a6f5ff962 Mon Sep 17 00:00:00 2001
From: Felix Conway <felix.conway@arm.com>
Date: Tue, 27 May 2025 16:00:48 +0100
Subject: [PATCH] Add fix for PEM underflow

Signed-off-by: Felix Conway <felix.conway@arm.com>
---
 library/pem.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/library/pem.c b/library/pem.c
index 0c7b0ec275..b97c378687 100644
--- a/library/pem.c
+++ b/library/pem.c
@@ -226,7 +226,10 @@ exit:
 #if defined(MBEDTLS_DES_C) || defined(MBEDTLS_AES_C)
 static int pem_check_pkcs_padding(unsigned char *input, size_t input_len, size_t *data_len)
 {
-    /* input_len > 0 is guaranteed by mbedtls_pem_read_buffer(). */
+    /* input_len > 0 is not guaranteed by mbedtls_pem_read_buffer(). */
+    if (input_len < 1) {
+        return MBEDTLS_ERR_PEM_INVALID_DATA;
+    }
     size_t pad_len = input[input_len - 1];
     size_t i;
 
-- 
2.39.5 (Apple Git-154)


From: Manuel Pégourié-Gonnard <manuel.pegourie-gonnard@arm.com>
Date: Mon, 26 May 2025 10:42:14 +0200
Subject: Fix bug in mbedtls_asn1_store_named_data()

When passed a zero-length val, the function was free-ing the buffer as
the documentation suggests:

 * \param val_len   The minimum length of the data buffer needed.
 *                  If this is 0, do not allocate a buffer for the associated
 *                  data.
 *                  If the OID was already present, enlarge, shrink or free
 *                  the existing buffer to fit \p val_len.

However it kept the previous length, leaving the val structure in the
corresponding item in the output list in an inconsistent state:

    p == NULL but len != 0

As a result, functions that would try using this item in the list
(including the same function!) afterwards would trip an dereference the
NULL pointer.

Signed-off-by: Manuel Pégourié-Gonnard <manuel.pegourie-gonnard@arm.com>
---
 library/asn1write.c                    | 1 +
 tests/suites/test_suite_x509write.data | 8 ++++----
 2 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/library/asn1write.c b/library/asn1write.c
index e6d8410..a5d0b93 100644
--- a/library/asn1write.c
+++ b/library/asn1write.c
@@ -429,6 +429,7 @@ mbedtls_asn1_named_data *mbedtls_asn1_store_named_data(
     {
         mbedtls_free( cur->val.p );
         cur->val.p = NULL;
+        cur->val.len = 0;
     }
     else if( cur->val.len != val_len )
     {
diff --git a/tests/suites/test_suite_x509write.data b/tests/suites/test_suite_x509write.data
index baf5553..d561a46 100644
--- a/tests/suites/test_suite_x509write.data
+++ b/tests/suites/test_suite_x509write.data
@@ -116,8 +116,8 @@ mbedtls_x509_string_to_names:"CN=ab,CN=cd,CN=ef":"CN=ef":0
 X509 String to Names (repeated OID, 1st is zero-length)
 mbedtls_x509_string_to_names:"CN=#0400,CN=cd,CN=ef":"CN=ef":0
 
-#X509 String to Names (repeated OID, middle is zero-length)
-#mbedtls_x509_string_to_names:"CN=ab,CN=#0400,CN=ef":"CN=ef":0
+X509 String to Names (repeated OID, middle is zero-length)
+mbedtls_x509_string_to_names:"CN=ab,CN=#0400,CN=ef":"CN=ef":0
 
 #X509 String to Names (repeated OID, last is zero-length)
 #mbedtls_x509_string_to_names:"CN=ab,CN=cd,CN=#0400":"CN=ef":0

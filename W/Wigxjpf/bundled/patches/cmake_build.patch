--- wigxjpf-1.13/CMakeLists.txt	2024-05-04 18:58:31
+++ wigxjpf-1.13-patched/CMakeLists.txt	2025-12-28 21:32:37
@@ -1,3 +1,9 @@
+cmake_minimum_required(VERSION 3.15)
+project(wigxjpf C)
+
+# Enable position-independent code for shared libraries
+set(CMAKE_POSITION_INDEPENDENT_CODE ON)
+
 include(CheckCSourceCompiles)
 
 check_c_source_compiles("
@@ -15,6 +21,10 @@
     HAS_LONG_DOUBLE
 )
 
+# Set required libraries for float128 check
+set(CMAKE_REQUIRED_LIBRARIES m quadmath)
+set(CMAKE_REQUIRED_QUIET TRUE)
+
 check_c_source_compiles("
     #include \"quadmath.h\"
     int main() {
@@ -31,6 +41,9 @@
     HAS_FLOAT128
 )
 
+# Reset required libraries
+unset(CMAKE_REQUIRED_LIBRARIES)
+
 check_c_source_compiles("
     __thread int global = 0;
     int main() {
@@ -160,3 +173,88 @@
   "-O3 -fPIC ${CMAKE_C_FLAGS}")
 
 target_compile_options(wigxjpf PRIVATE -Wno-shadow)
+target_link_libraries(wigxjpf PRIVATE m)
+
+# Build quadmath extension if float128 is available
+if (HAS_FLOAT128)
+    add_library(wigxjpf_quadmath STATIC
+        src/calc_float128.c
+        src/c_wrap_float128.c
+    )
+    
+    target_include_directories(wigxjpf_quadmath
+        PUBLIC
+            inc/
+        PRIVATE
+            cfg/
+            src/
+            ${CMAKE_CURRENT_BINARY_DIR}
+    )
+    
+    target_compile_options(wigxjpf_quadmath PRIVATE -O3 -Wno-shadow)
+    target_link_libraries(wigxjpf_quadmath PRIVATE m quadmath)
+endif()
+
+# Shared library: base version (double + long_double)
+add_library(wigxjpf_shared SHARED
+    src/prime_factor.c
+    src/calc.c
+    src/trivial_zero.c
+    src/c_wrap.c
+    src/fortran_wrap.c
+    src/wigxjpf_error.c
+)
+
+target_include_directories(wigxjpf_shared
+    PUBLIC
+        inc/
+    PRIVATE
+        cfg/
+        src/
+        ${CMAKE_CURRENT_BINARY_DIR}
+)
+
+target_compile_options(wigxjpf_shared PRIVATE -O3 -Wno-shadow)
+target_link_libraries(wigxjpf_shared PRIVATE m)
+
+# Set output name to match Makefile convention
+set_target_properties(wigxjpf_shared PROPERTIES OUTPUT_NAME wigxjpf_shared)
+
+# Shared library: quadmath version (adds float128 support)
+if (HAS_FLOAT128)
+    add_library(wigxjpf_quadmath_shared SHARED
+        src/prime_factor.c
+        src/calc.c
+        src/trivial_zero.c
+        src/c_wrap.c
+        src/fortran_wrap.c
+        src/wigxjpf_error.c
+        src/calc_float128.c
+        src/c_wrap_float128.c
+    )
+    
+    target_include_directories(wigxjpf_quadmath_shared
+        PUBLIC
+            inc/
+        PRIVATE
+            cfg/
+            src/
+            ${CMAKE_CURRENT_BINARY_DIR}
+    )
+    
+    target_compile_options(wigxjpf_quadmath_shared PRIVATE -O3 -Wno-shadow)
+    target_link_libraries(wigxjpf_quadmath_shared PRIVATE m quadmath)
+    
+    set_target_properties(wigxjpf_quadmath_shared PROPERTIES OUTPUT_NAME wigxjpf_quadmath_shared)
+endif()
+
+# Install targets
+install(TARGETS wigxjpf_shared
+        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
+        RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})
+
+if (HAS_FLOAT128)
+    install(TARGETS wigxjpf_quadmath_shared
+            LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
+            RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR})
+endif()
